# Zero Email - Raspberry Pi Deployment
# Fully self-hosted with Miniflare for backend
#
# Usage:
#   docker compose -f docker-compose.pi.yaml up -d
#
# Services:
#   - nginx: Frontend static files + reverse proxy to backend
#   - miniflare: Backend (Cloudflare Workers via Miniflare)
#   - db: PostgreSQL 17 database
#   - valkey: Redis-compatible cache
#   - upstash-proxy: HTTP proxy for Redis (Upstash API compatibility)
#   - migrations: One-time database migrations

services:
  # ========================================
  # Nginx - Frontend & Reverse Proxy
  # ========================================
  nginx:
    image: nginx:alpine
    container_name: zero-nginx
    restart: unless-stopped
    ports:
      - "3000:80"
    volumes:
      - ./apps/mail/build/client:/usr/share/nginx/html:ro
      - ./nginx.pi.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      miniflare:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '--spider', '--quiet', 'http://127.0.0.1:80/']
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ========================================
  # Miniflare - Backend (Cloudflare Workers Local)
  # ========================================
  miniflare:
    build:
      context: .
      dockerfile: docker/pi/Dockerfile.miniflare
    container_name: zero-backend
    restart: unless-stopped
    environment:
      # Database connection (direct to local Postgres)
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-zerodotemail}
      # Redis connection via Upstash HTTP proxy
      REDIS_URL: http://upstash-proxy:80
      REDIS_TOKEN: ${REDIS_TOKEN:-upstash-local-token}
      # Auth configuration
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:-change-me-in-production}
      BETTER_AUTH_URL: ${APP_URL:-http://raspberrypi.local:3000}
      COOKIE_DOMAIN: ${COOKIE_DOMAIN:-raspberrypi.local}
      # Google OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      # API Keys
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o}
      OPENAI_MINI_MODEL: ${OPENAI_MINI_MODEL:-gpt-4o-mini}
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY:-}
      # App URLs
      VITE_PUBLIC_BACKEND_URL: ${BACKEND_URL:-http://raspberrypi.local:3000/api}
      VITE_PUBLIC_APP_URL: ${APP_URL:-http://raspberrypi.local:3000}
      # Local mode settings
      NODE_ENV: production
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production}
      # Disable cloud-specific features
      DISABLE_WORKFLOWS: "true"
      DISABLE_CALLS: "true"
      USE_OPENAI: "true"
    volumes:
      # Persist Miniflare data (Durable Objects, KV, R2)
      - miniflare-data:/app/data
    depends_on:
      db:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
      upstash-proxy:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '--spider', '--quiet', 'http://127.0.0.1:8787/']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    # Pi-optimized resource limits
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # ========================================
  # Database Migrations
  # ========================================
  migrations:
    build:
      context: .
      dockerfile: docker/db/Dockerfile
    container_name: zero-migrations
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-zerodotemail}
    depends_on:
      db:
        condition: service_healthy
    command: ['pnpm', 'run', 'db:migrate']
    restart: 'no'

  # ========================================
  # PostgreSQL Database
  # ========================================
  db:
    image: postgres:17-alpine
    container_name: zero-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-zerodotemail}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD', 'pg_isready', '-U', 'postgres', '-d', 'zerodotemail']
      interval: 10s
      timeout: 5s
      retries: 5
    # Pi-optimized PostgreSQL settings
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=128MB"
      - "-c"
      - "effective_cache_size=256MB"
      - "-c"
      - "maintenance_work_mem=32MB"
      - "-c"
      - "work_mem=4MB"
      - "-c"
      - "max_connections=50"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ========================================
  # Valkey (Redis-compatible)
  # ========================================
  valkey:
    image: docker.io/bitnami/valkey:8.0
    container_name: zero-valkey
    restart: unless-stopped
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
      - VALKEY_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
      # Pi-optimized memory settings
      - VALKEY_EXTRA_FLAGS=--maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - valkey-data:/bitnami/valkey/data
    healthcheck:
      test: ['CMD', 'redis-cli', '-h', 'localhost', '-p', '6379', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 192M
        reservations:
          memory: 64M

  # ========================================
  # Upstash HTTP Proxy (Redis over HTTP)
  # ========================================
  upstash-proxy:
    image: hiett/serverless-redis-http:latest
    container_name: zero-upstash-proxy
    restart: unless-stopped
    environment:
      SRH_MODE: env
      SRH_TOKEN: ${REDIS_TOKEN:-upstash-local-token}
      SRH_CONNECTION_STRING: 'redis://valkey:6379'
    depends_on:
      valkey:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '--spider', '--quiet', 'http://127.0.0.1:80']
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 32M

volumes:
  postgres-data:
    name: zero-postgres-data
  valkey-data:
    name: zero-valkey-data
  miniflare-data:
    name: zero-miniflare-data

networks:
  default:
    name: zero-network
