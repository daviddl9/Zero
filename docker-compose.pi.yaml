# Zero Email - Raspberry Pi Deployment Override
#
# This override configures Zero for deployment alongside statement-parser:
# - Port 3001 instead of 3000 (statement-parser uses 3000)
# - Uses shared MinIO instance from statement-parser (port 9000/9001)
# - Connects to external network for MinIO access
#
# Usage:
#   docker compose -f docker-compose.standalone.yaml -f docker-compose.pi.yaml up -d
#
# Prerequisites:
#   - statement-parser running with MinIO on ports 9000/9001
#   - Create 'threads' bucket in MinIO console at http://192.168.7.14:9001
#
# Environment variables (set in .env):
#   S3_ENDPOINT_EXTERNAL - External MinIO URL (e.g., http://192.168.7.14:9000)
#   MINIO_ROOT_USER - MinIO admin user (match statement-parser's config)
#   MINIO_ROOT_PASSWORD - MinIO admin password (match statement-parser's config)

services:
  # ========================================
  # Nginx - Change port to 3001 (override default 3000)
  # ========================================
  nginx:
    ports: !override
      - "3001:80"

  # ========================================
  # Backend Server - Use external MinIO
  # ========================================
  server:
    environment:
      # Override S3 endpoint to use external MinIO (statement-parser's instance)
      # On Pi, use the host's IP or docker bridge gateway
      S3_ENDPOINT: ${S3_ENDPOINT_EXTERNAL:-http://172.17.0.1:9000}
    # Override depends_on to remove minio dependency
    depends_on:
      db:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
      valkey:
        condition: service_healthy

  # ========================================
  # Valkey - Use redis:7-alpine (ARM compatible)
  # ========================================
  valkey:
    image: redis:7-alpine
    container_name: zero-valkey
    restart: unless-stopped
    command: >
      redis-server
      --maxmemory 192mb
      --maxmemory-policy noeviction
      --appendonly yes
    volumes:
      - valkey-data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', '-h', 'localhost', '-p', '6379', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # ========================================
  # Disable MinIO - Using shared instance from statement-parser
  # ========================================
  minio:
    deploy:
      replicas: 0

volumes:
  valkey-data:
    name: zero-valkey-data
