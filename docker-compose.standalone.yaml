# Zero Email - Standalone Deployment (No Cloudflare Workers)
# Fully self-hosted with BullMQ for job processing
#
# Usage:
#   docker compose -f docker-compose.standalone.yaml up -d
#
# Services:
#   - nginx: Frontend static files + reverse proxy to backend
#   - server: Node.js backend with BullMQ workers
#   - db: PostgreSQL 17 database
#   - valkey: Redis-compatible cache + job queue
#   - minio: S3-compatible object storage for thread data
#   - migrations: One-time database migrations

services:
  # ========================================
  # Nginx - Frontend & Reverse Proxy
  # ========================================
  nginx:
    build:
      context: .
      dockerfile: docker/nginx/Dockerfile
      args:
        VITE_PUBLIC_APP_URL: ${APP_URL:-http://localhost:3000}
        VITE_PUBLIC_BACKEND_URL: ${BACKEND_URL:-http://localhost:3000}
    container_name: zero-nginx
    restart: unless-stopped
    ports:
      - "3000:80"
    # volumes:
    #   - ./apps/mail/build/client:/usr/share/nginx/html:ro
    #   - ./nginx.standalone.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      server:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '--spider', '--quiet', 'http://127.0.0.1:80/']
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ========================================
  # Backend Server (Node.js + BullMQ)
  # ========================================
  server:
    build:
      context: .
      dockerfile: docker/standalone/Dockerfile
    container_name: zero-server
    restart: unless-stopped
    environment:
      # Self-hosted mode
      SELF_HOSTED: "true"
      STANDALONE: "true"

      # Database connection
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-zerodotemail}

      # Redis connection (native, no HTTP proxy needed)
      REDIS_HOST: valkey
      REDIS_PORT: 6379
      REDIS_PASSWORD: ""

      # S3/MinIO object storage
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      S3_BUCKET: ${S3_BUCKET:-threads}
      S3_REGION: us-east-1

      # Auth configuration
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:-change-me-in-production}
      BETTER_AUTH_URL: ${APP_URL:-http://localhost:3000}
      COOKIE_DOMAIN: ${COOKIE_DOMAIN:-localhost}
      BETTER_AUTH_TRUSTED_ORIGINS: ${BETTER_AUTH_TRUSTED_ORIGINS:-http://localhost:3000}

      # Google OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI:-http://localhost:3000/api/auth/callback/google}

      # API Keys
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o}
      OPENAI_MINI_MODEL: ${OPENAI_MINI_MODEL:-gpt-4o-mini}
      GOOGLE_GENERATIVE_AI_API_KEY: ${GOOGLE_GENERATIVE_AI_API_KEY:-}
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}

      # App URLs
      VITE_PUBLIC_BACKEND_URL: ${BACKEND_URL:-http://localhost:3000}
      VITE_PUBLIC_APP_URL: ${APP_URL:-http://localhost:3000}
      BASE_URL: ${BASE_URL:-http://localhost:3000}

      # Server settings
      PORT: 8787
      NODE_ENV: production
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production}

      # Job queue settings
      ENABLE_JOB_QUEUE: "true"
      ENABLE_SCHEDULER: "true"
      WORKER_CONCURRENCY: 2

      # Enable workflows (now using BullMQ)
      DISABLE_WORKFLOWS: "false"
      DISABLE_CALLS: "true"
    depends_on:
      db:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
      valkey:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '--spider', '--quiet', 'http://127.0.0.1:8787/health']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    # Resource limits for Raspberry Pi (4GB model)
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # ========================================
  # Database Migrations
  # ========================================
  migrations:
    build:
      context: .
      dockerfile: docker/db/Dockerfile
    container_name: zero-migrations
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-zerodotemail}
    depends_on:
      db:
        condition: service_healthy
    command: ['sh', '/app/apps/server/scripts/migrate.sh']
    restart: 'no'

  # ========================================
  # PostgreSQL Database (with pgvector for AI embeddings)
  # ========================================
  db:
    image: pgvector/pgvector:pg17
    container_name: zero-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-zerodotemail}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD', 'pg_isready', '-U', 'postgres', '-d', 'zerodotemail']
      interval: 10s
      timeout: 5s
      retries: 5
    # Optimized PostgreSQL settings for limited memory
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=128MB"
      - "-c"
      - "effective_cache_size=256MB"
      - "-c"
      - "maintenance_work_mem=32MB"
      - "-c"
      - "work_mem=4MB"
      - "-c"
      - "max_connections=50"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ========================================
  # Valkey (Redis-compatible) - Cache + Job Queue
  # ========================================
  valkey:
    image: docker.io/bitnami/valkey:8.0
    container_name: zero-valkey
    restart: unless-stopped
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
      - VALKEY_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
      # Optimized memory settings
      - VALKEY_EXTRA_FLAGS=--maxmemory 192mb --maxmemory-policy noeviction
    volumes:
      - valkey-data:/bitnami/valkey/data
    healthcheck:
      test: ['CMD', 'redis-cli', '-h', 'localhost', '-p', '6379', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # ========================================
  # MinIO - S3-compatible Object Storage
  # Stores email thread content (replaces Cloudflare R2)
  # ========================================
  minio:
    image: minio/minio:latest
    container_name: zero-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio-data:/data
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Web Console
    healthcheck:
      test: ['CMD', 'mc', 'ready', 'local']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

volumes:
  postgres-data:
    name: zero-postgres-data
  valkey-data:
    name: zero-valkey-data
  minio-data:
    name: zero-minio-data

networks:
  default:
    name: zero-network
